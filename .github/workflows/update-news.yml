name: ğŸ¤– Auto-update News from GAS

on:
  schedule:
    - cron: '0 */2 * * *'  # 2æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:        # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # ã‚³ãƒŸãƒƒãƒˆæ¨©é™ã‚’ä»˜ä¸
    steps:
      - uses: actions/checkout@v4
      
      - name: Download news.json from Google Drive
        run: |
          # ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã„å ´åˆã«å‚™ãˆã¦ä½œæˆ
          mkdir -p data
          # Google Driveã‹ã‚‰ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (-Lã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¿½å¾“)
          curl -L -o data/news.json "https://drive.google.com/uc?export=download&id=1hteuEBEmsH0zThg-xmBPH7IYkwbnHVDA"
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code data/news.json || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config user.name "GADGET HUNTER Bot"
          git config user.email "actions@github.com"
          git add data/news.json
          
          # è¨˜äº‹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
          ARTICLE_COUNT=$(grep -o '"title"' data/news.json | wc -l)
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M JST')
          
          git commit -m "ğŸ¤– Auto-update: $ARTICLE_COUNT articles from GAS [$CURRENT_DATE]"
          git push
