name: ğŸ¤– Auto-update News from GAS

on:
  schedule:
    - cron: '0 * * * *'  # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”„ Download latest news.json from Google Drive
        run: |
          echo "ğŸ“¡ Fetching latest news from GAS..."
          mkdir -p frontend/data
          curl -L -o frontend/data/news.json "https://docs.google.com/uc?export=download&id=1Q0CjYkMIJOKPZBW6OLj3sP_pcmmm4fdx"
          
          if [ -f frontend/data/news.json ]; then
            echo "âœ… news.json downloaded successfully"
            echo "ğŸ“Š File size: $(wc -c < frontend/data/news.json) bytes"
            echo "ğŸ“ Article count: $(grep -o '"title"' frontend/data/news.json | wc -l)"
          else
            echo "âŒ Failed to download news.json"
            exit 1
          fi
      
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          git diff --exit-code frontend/data/news.json || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GADGET HUNTER Bot"
          git config user.email "actions@github.com"
          git add frontend/data/news.json
          
          ARTICLE_COUNT=$(grep -o '"title"' frontend/data/news.json | wc -l)
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M JST')
          
          git commit -m "ğŸ¤– Auto-update: $ARTICLE_COUNT articles from GAS [$CURRENT_DATE]"
          git push
          
          echo "âœ… Successfully pushed updates to GitHub!"
      
      - name: ğŸ‰ No changes detected
        if: steps.check_changes.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸ No new articles found. news.json is up to date."
      
      - name: ğŸš¨ Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ GADGET HUNTER - Auto-update Failed';
            const body = `## âŒ ãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–°ãŒå¤±æ•—ã—ã¾ã—ãŸ
            
            **å¤±æ•—æ—¥æ™‚:** ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${context.workflow}
            **å®Ÿè¡ŒID:** ${context.runId}
            
            ### ğŸ“‹ è©³ç´°
            - **ãƒªãƒã‚¸ãƒˆãƒª:** ${context.repo.owner}/${context.repo.repo}
            - **ãƒ–ãƒ©ãƒ³ãƒ:** ${context.ref}
            - **ã‚³ãƒŸãƒƒãƒˆ:** ${context.sha.substring(0, 7)}
            
            ### ğŸ” ç¢ºèªã™ã¹ãç‚¹
            1. Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«ID (1Q0CjYkMIJOKPZBW6OLj3sP_pcmmm4fdx) ãŒæ­£ã—ã„ã‹
            2. ãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰è¨­å®šãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹
            3. GASãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹
            
            [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation']
            });