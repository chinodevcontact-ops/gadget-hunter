name: ğŸ¤– Auto-update News from GAS

on:
  schedule:
    - cron: '0 * * * *'  # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”„ Download latest news.json from Google Drive
        run: |
          echo "ğŸ“¡ Fetching latest news from GAS..."
          mkdir -p frontend/data
          curl -L -o frontend/data/news.json "https://docs.google.com/uc?export=download&id=1hteuEBEmsH0zThg-xmBPH7IYkwbnHVDA"
          
          if [ -f frontend/data/news.json ]; then
            echo "âœ… news.json downloaded successfully"
            echo "ğŸ“Š File size: $(wc -c < frontend/data/news.json) bytes"
            echo "ğŸ“ Article count: $(grep -o '"title"' frontend/data/news.json | wc -l)"
          else
            echo "âŒ Failed to download news.json"
            exit 1
          fi
      
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          git diff --exit-code frontend/data/news.json || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GADGET HUNTER Bot"
          git config user.email "actions@github.com"
          git add frontend/data/news.json
          
          ARTICLE_COUNT=$(grep -o '"title"' frontend/data/news.json | wc -l)
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M JST')
          
          git commit -m "ğŸ¤– Auto-update: $ARTICLE_COUNT articles from GAS [$CURRENT_DATE]"
          git push
          
          echo "âœ… Successfully pushed updates to GitHub!"
      
      - name: ğŸ‰ No changes detected
        if: steps.check_changes.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸ No new articles found. news.json is up to date."
